<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (c)  Oracle and/or its affiliates. All rights reserved.
-->
<Configuration status="fatal">
    <Properties>
        <Property name="log_base_dir">.</Property><!-- TODO: baseDir -->
        <Property name="log_dir">${log_base_dir}/logs/mv-creator</Property>
        <Property name="json_log_dir">${log_dir}/json</Property>
        <Property name="service_name">mv-creator</Property>
        <Property name="log_subdir">${sys:sessionId:-default}</Property>
        <!-- read sessionId as system property, if not present use default -->
        <Property name="standard_archive">${log_dir}/${log_subdir}/${service_name}-%d{yyyy-MM-dd-HH}_%i.log.gz
        </Property>
        <Property name="json_archive">${json_log_dir}/${service_name}-%d{yyyy-MM-dd-HH}_%i.json.log.gz</Property>
        <Property name="log_pattern">%d{yyyy-MM-dd HH:mm:ss}[%5X{nsid}] [%5X{pid}] %-5p %c{1}:%L - %m%n</Property>
        <!-- General properties for log rotation -->
        <Property name="max_log_size">5 MB</Property>
        <Property name="rollover_max_files">10</Property>
    </Properties>
    <Appenders>

        <Console name="CONSOLE" target="SYSTEM_OUT" follow="true">
            <PatternLayout pattern="${log_pattern}"/>
        </Console>

        <!-- Standard log file generation -->
        <RollingFile name="fileAppender" fileName="${log_dir}/${log_subdir}/${service_name}.log"
                     filePattern="${standard_archive}" ignoreExceptions="false">
            <PatternLayout pattern="${log_pattern}"/>
            <Policies>
                <SizeBasedTriggeringPolicy size="${max_log_size}"/>
            </Policies>
            <DefaultRolloverStrategy max="${rollover_max_files}"/>
        </RollingFile>


        <!-- JSONTemplate based log generation
         https://logging.apache.org/log4j/2.x/manual/json-template-layout.html
         -->
        <ConcurrentProcessAppender name="jsonTemplateLayoutAppender" fileName="${json_log_dir}/${service_name}.json.log"
                                   filePattern="${json_archive}" ignoreExceptions="false" bufferSize="128">
            <!--
             maxStringLength - truncate string values longer than the specified limit (defaults to 16384)
             eventTemplateUri - customize json log file attributes.
            -->
            <JsonTemplateLayout eventTemplateUri="classpath:jsonTemplateLayout.json" maxStringLength="916384">
                <EventTemplateAdditionalField key="service" value="${service_name}"/>
                <EventTemplateAdditionalField key="hostname" value="${hostName}"/>
            </JsonTemplateLayout>
            <Policies>
                <SizeBasedTriggeringPolicy size="${max_log_size}"/>
            </Policies>
            <DefaultRolloverStrategy max="${rollover_max_files}"/>
        </ConcurrentProcessAppender>

        <!--This can only contain log configuration errors -->
        <RollingFile name="exceptionHandlerAppender" fileName="${log_dir}/${log_subdir}/errors.log"
                     filePattern="${standard_archive}" ignoreExceptions="false">
            <PatternLayout pattern="${log_pattern}"/>
            <TimeBasedTriggeringPolicy/>
        </RollingFile>

        <Failover name="errorHandlerJsonAppender" primary="jsonTemplateLayoutAppender">
            <Failovers>
                <AppenderRef ref="exceptionHandlerAppender"/>
            </Failovers>
        </Failover>

    </Appenders>

    <Loggers>
        <Root level="info" additivity="false">
            <AppenderRef ref="fileAppender"/>
            <AppenderRef ref="errorHandlerJsonAppender"/>
            <!--<AppenderRef ref="CONSOLE"/>-->
        </Root>
    </Loggers>
</Configuration>